---
title: "Detecting life-threatening patterns in Point-of-care ECG using efficient memory and processor power"
titlerunning:  ECG using efficient memory and processor power
authorrunning: Bischoff F.
editor_options:
  markdown:
    doctype: pandoc
    mode: markdown
    wrap: 120
  chunk_output_type: inline
output:
  # bookdown::html_document2:
  #   toc: false
  #   toc_float: false
  #   fig_caption: yes
  #   keep_tex: yes
  #   keep_md: yes
  #   css: style.css
  #   number_sections: true
  #   theme: default
  #   highlight: tango
  #   md_extensions: -tex_math_single_backslash-tex_math_double_backslash
  # pdf_document:
  #   keep_tex: yes
  #   keep_md: yes
  #   fig_caption: yes
  #   citation_package: default
  #   latex_engine: pdflatex
  #   template: template.tex
  #   md_extensions: -tex_math_single_backslash-tex_math_double_backslash
  bookdown::pdf_document2:
    extra_dependencies: ["svg", "flafter", "subfig"]
    keep_tex: yes
    keep_md: yes
    fig_caption: yes
    citation_package: default
    latex_engine: pdflatex
    template: template.tex
    md_extensions: -tex_math_single_backslash-tex_math_double_backslash
authors:
- name: Francisco Bischoff
  inst: 1, 2
  orcid: 0000-0002-5301-8672
- name: Pedro Pereira Rodrigues
  inst: 1, 2
  orcid: 0000-0001-7867-6682
institutes:
- num: 1
  dept: |
    Department of Community Medicine, Information and Health Decision Sciences (MEDCIDS), Faculty of
    Medicine, University of Porto, Porto, Portugal
- num: 2
  dept: |
    Center for Health Technology and Services Research (CINTESIS), Faculty of Medicine, University of
    Porto, Porto, Portugal
keywords:
- anomaly detection
- ECG
- matrix profile
- time series
- point-of-care
abstract: |
  Currently, Point-of-Care (POC) ECG monitoring works either as plot devices or alarms for abnormal
  cardiac rhythms using predefined normal trigger ranges and some rhythm analysis, which raises the
  problem of false alarms. In comparison, complex 12-derivation ECG machines are not suitable to use
  as simple monitors and are used with strict techniques for formal diagnostics. Thinking outside the
  ICU setting, where high-end devices are available for patient monitoring, we aim to identify, on
  streaming data, life-threatening hearth electric patterns using low CPU and memory, enabling ward
  monitors, home devices and even wearable devices to be able to identify such events.
bibliography: '`r here::here("papers", "references.bib")`'
link-citations: true
csl: llncs-alpha.csl
thanks: |
  This work has been done under the scope of - and funded by - the Ph.D. Program in Health Data
  Science of the Faculty of Medicine of the University of Porto, Portugal - heads.med.up.pt
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
library(here)
library(glue)
library(tibble)
library(kableExtra)

knitr::opts_chunk$set(
  echo = FALSE, fig.align = "center", autodep = TRUE
)
knitr::opts_knit$set(
  progress = TRUE, verbose = TRUE
)
if (knitr::is_latex_output()) {
  knitr::opts_chunk$set(dev = "pdf")
} else {
  knitr::opts_chunk$set(dev = "svg")
}

my_graphics <- function(image_name, base_path = here::here("docs", "figure")) {
  file_path <- glue::glue("{base_path}/{image_name}")

  if (knitr::is_latex_output()) {
    if (file.exists(glue::glue("{file_path}.pdf"))) {
      file_path <- glue::glue("{file_path}.pdf")
    } else if (file.exists(glue::glue("{file_path}.png"))) {
      file_path <- glue::glue("{file_path}.png")
    } else {
      file_path <- glue::glue("{file_path}.jpg")
    }
  } else {
    if (file.exists(glue::glue("{file_path}.svg"))) {
      file_path <- glue::glue("{file_path}.svg")
    } else if (file.exists(glue::glue("{file_path}.png"))) {
      file_path <- glue::glue("{file_path}.png")
    } else {
      file_path <- glue::glue("{file_path}.jpg")
    }
  }

  knitr::include_graphics(file_path)
}
```

<!-- Papers should be submitted in PDF format through the
[EPIA 2022 EasyChair submission page](https://easychair.org/conferences/?conf=epia2022), and they
should be prepared according to the
[Springer LNCS](http://www.springer.com/gp/computer-science/lncs/conference-proceedings-guidelines)
format.  Submissions to the Doctoral Symposium have a maximum of 3 pages + references, and will be
compiled in a separate informal PDF volume.  Submissions must be authored by the PhD candidate, and
should include information regarding the advisor(s) as a footnote in the first page, anchored in the
author's name.  Submissions should also include a short abstract, keywords, introduction to the
topic being addressed in the project and relevant research questions, a brief state of the art in
the field, and the methodology to be pursued. -->


# Introduction

Currently, Point-of-Care (POC) ECG monitoring works either as plot devices or alarms for abnormal
cardiac rhythms using predefined normal trigger ranges. Modern devices also incorporate algorithms
to analyze arrhythmias improving their specificity. On the other hand, full 12-derivation ECG
machines are complex, are not suited to use as simple monitors, and are used with strict techniques
for formal diagnostics of hearth electric conduction pathologies. The automatic diagnostics are
derived from a complete analysis of the 12-dimension data after it is fully and well collected.

In February of 2015, the CinC/Physionet Challenge 2015 was about "Reducing False Arrhythmia Alarms
in the ICU" [@Clifford2015]. The introduction article stated that it had been reported that up to 86%
resulting of the alarms are false, and this can lead to decreased staff attention and an increase in
patients' delirium [@Lawless1994; @Chambrin2001; @Parthasarathy2004].

This subject draws attention to the importance of correctly identify abnormal hearth electric
patterns.  Meanwhile, this opens the opportunity of thinking outside the ICU setting, where we still
monitoring patients (and ourselves) using devices with low processing power, as for example ward
monitors, home devices and wearable devices.

# Objectives and research question

While this research was inspired on the CinC/Physionet Challenge 2015, its purpose is not to beat
the state of the art on that challenge, but to identify, on streaming data, abnormal hearth electric
patterns, specifically those which are life-threatening, using low CPU and low memory requirements.

The main questions is: can we accomplish this objective using a minimalist approach (low CPU, low
memory) while maintaining robustness?

# Related Works

Their algorithm did a pretty good job on the Physionet test set.  However, independently of their
approach to this problem, none of the authors reported benchmarks, memory usage, robustness test, or
context invariance that could assure its implementation on real monitors to reduce alarm fatigue
indeed.

There are other arrhythmias that this challenge did not assess, like atrial standstill
(hyperkalemia), third-degree atrioventricular block, and others that may be life-threatening in some
settings.  Pulseless electrical activity is a frequent condition in cardiac arrest but cannot be
identified without blood pressure information.  This information is usually present in ICU settings
but not in other locations.

# The planned approach and methods for solving the problem

## The data

The dataset used is the CinC/Physionet Challenge 2015 public dataset [@Clifford2015], composed of
750 patients with at least five minutes records.  The _events_ we seek to identify are the
life-threatening arrhythmias as defined by Physionet in Table \@ref(tab:alarms).

```{r alarms, echo=FALSE}
alarms <- tribble(
  ~Alarm, ~Definition,
  "Asystole", "No QRS for at least 4 seconds",
  "Extreme Bradycardia", "Heart rate lower than 40 bpm for 5 consecutive beats",
  "Extreme Tachycardia", "Heart rate higher than 140 bpm for 17 consecutive beats",
  "Ventricular Tachycardia", "5 or more ventricular beats with heart rate higher than 100 bpm",
  "Ventricular Flutter/Fibrillation", "Fibrillatory, flutter, or oscillatory waveform for at least 4 seconds"
)

kbl(alarms,
  booktabs = TRUE,
  caption = "Definition of the five alarm types used in CinC/Physionet Challenge 2015.",
  align = "ll",
  position = "ht"
) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = TRUE)
```

## Matrix Profile

This work will use the state-of-the-art [@DePaepe2020; @Feremans2020] time series analysis technique
called Matrix Profile (MP) that once computed, allows us to derive frameworks to all sorts of tasks,
as motif discovery, anomaly detection, regime change detection and others [@Yeh2017a].

The streaming data, coming from one patient, is processed to create its MP in real-time.  Then, the
FLOSS algorithm [@gharghabi2018] is computed for detecting a regime change.  When a new regime is
detected, a sample of this new regime is analysed by a model and a decision is made.  If the new
regime is life-threatening, the alarm will be fired.

## Detecting regime changes

The regime change detection will be using the FLOSS algorithm [@gharghabi2018] which is an on-line
algorithm built on top of the computed MP.  The algorithm is based on the assumption that between
two regimes, the most similar shape (its nearest neighbor, 1-NN) is located on "the same side".  The
details of the algorithm are described in the original paper [@gharghabi2018].  In short, the
algorithm keeps track of the number of 1-NN references (called _Arc Counts_) that crosses a point in
time.  As shown on the original article, figures 2 and 3 [@gharghabi2018], a drop in the Arc Counts
indicates a regime change.

```{r flossregime, echo=FALSE, out.width="100%"}
#| fig.cap="Regime change detection example.
#|  The graph on top shows the ECG streaming; the  green line marks the ten seconds
#|  before the original alarm was fired; the red line marks the minimum amount of
#|  time for asystole criteria; the blue horizontal line represents the size of the sliding window.
#|  The graph on the bottom shows the Corrected Arc Counts as seen by the algorithm;
#|  the red line marks the detection point."
my_graphics("graph_regime_floss")
```

## Classification of the new regime

The next step towards the objective of this work is to verify if the new regime detected by the
previous step is indeed a life-threatening pattern that we should trigger the alarm.

The method of choice is classification. The simplest algorithm could be a `TRUE`/`FALSE` binary
classification. Nevertheless, the five life-threatening patterns have well defined characteristics
that may seem more plausible to classify the new regime using some kind of ensamble of binary
classifiers or a "six-class" classifier (being the sixth class the `FALSE` class).

Since the model doesn't know which life-threatening pattern will be present in the regime (or if it
will be a `FALSE` case), the model will need to check for all five `TRUE` cases and if none of these
cases are identified, it will classify the regime as `FALSE`.

In order to avoid exceeding processor capacity, an initial set of shapelets [@Rakthanmanon2013] can
be sufficient to build the `TRUE`/`FALSE` classifier. And to build such set of shapelets, leveraging
on the MP, we will use the Contrast Profile [@Mercer2021].

The Contrast Profile (CP) looks for patterns that are at the same time very *similar* to its
neighbors in class *A* while is very *different* from the nearest neighbor from class *B*. In other
words, this means that such pattern represents well class *A* and may be taken as a "signature" of
that class.

For a more complete understanding of the process, in the original article, the figure 6 shows a
practical example [@Mercer2021].

In this work, an example of candidates for ventricular tachycardia is presented on Fig. \@ref(fig:vtachy).

```{r vtachy, echo=FALSE, out.width="90%", fig.cap="Shapelet candidates for Ventricular Tachycardia.", fig.height=9, fig.width=14}
def_par <- graphics::par(no.readonly = TRUE)
graphics::layout(matrix(1:6, ncol = 2, byrow = TRUE))
graphics::par(mai = c(0.8, 0.5, 0.6, 0.5), cex = 1)

data <- readRDS(here("presentations/Report/contrast.rds"))

for (i in (1:6)) {
  plot(tsmp:::znorm(data[[i]]$plato), type = "l", ylab = "", xlab = "samples (250hz)")
  for (j in seq_along(data[[i]]$neighbors)) {
    lines(tsmp:::znorm(data[[i]]$neighbors[[j]]$data), col = j + 1)
  }
}
graphics::par(def_par)
```

## Feasibility trial

A side-project called "false.alarm.io" has been derived from this work (an unfortunate mix of
"false.alarm" and "PlatformIO" [@PlatformIO], the IDE chosen to interface the panoply of embedded
systems we can experiment with). The current results of this side-project are very enlightening and
show that the final algorithm can indeed be used in small hardware. Further data will be available
in the future.

# Research Team

-  Thesis Author: Francisco Bischoff
-  Supervisor: Professor Pedro Pereira Rodrigues
-  Co-supervisor: Professor Eamonn Keogh (UCR, Riverside)

# Expected results and outcomes

At the end, this thesis will provide a framework for identify life-threatening conditions using
biological streaming data on devices with low CPU and low memory specifications. We expect
to achieve a high quality model on identifying these pathological conditions, maintaining its
robustness in presence of noise and artifacts seen on real-world applications.

# References
